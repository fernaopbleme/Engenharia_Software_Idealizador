<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TeamBuilder - Home</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="./css/home.css">
</head>
<body class="bg-gray-50 min-h-screen">

  <header class="bg-gradient-to-r from-indigo-500 via-purple-600 to-violet-700 border-b border-white/20 px-6 py-4 shadow-md">
    <div class="max-w-7xl mx-auto flex items-center justify-between">
      <h1 class="text-2xl font-bold text-white">TeamBuilder</h1>
      <nav class="flex items-center gap-6">
        <a href="../Criar_projeto/criar_projeto.html" class="text-white px-4 py-2 rounded-xl hover:bg-white/20 transition-colors font-medium">Nova Ideia</a>
      </nav>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-6 py-12">
    <section class="bg-white rounded-2xl shadow-sm border border-gray-200 p-12 mb-8">
      <div class="text-center mb-8">
        <h2 class="text-5xl font-bold text-gray-900 mb-4">Encontre Sua Equipe</h2>
        <p class="text-gray-500 text-lg">Busque colaboradores por habilidades</p>
      </div>

      <div class="flex gap-3 max-w-3xl mx-auto mb-8">
        <div class="flex-1 relative">
          <svg class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
          </svg>
          <input id="searchInput" type="text" placeholder="Ex.: React, DevOps, Java..." class="w-full pl-12 pr-4 py-3.5 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-gray-900 text-gray-700"/>
        </div>
        <button id="searchBtn" class="bg-violet-700 text-white px-8 py-3.5 rounded-xl transition duration-200 font-medium hover:brightness-105 focus:outline-none focus:ring-2 focus:ring-purple-700">
          Buscar
        </button>
      </div>

      <div class="text-center mb-8">
        <button id="addMemberBtn" class="border-2 border-dashed border-gray-300 text-gray-700 px-6 py-3 rounded-xl hover:border-gray-400 hover:bg-gray-50 transition-colors font-medium">
          + Adicionar Colaborador
        </button>
      </div>

      <div id="colaboradoresContainer" class="mt-8 hidden"></div>
    </section>

    <section>
      <div class="bg-violet-700 text-white px-8 py-4 rounded-t-2xl inline-block">
        <h2 class="text-2xl font-bold">Meus projetos:</h2>
      </div>
      <div id="projectsContainer" class="space-y-6 mt-2"></div>
    </section>
  </main>

  <script>
    /* ===================== CONFIG ===================== */
    var API_BASE = "https://bdprojetos.azurewebsites.net";
    var AUTH_KEY = "auth.user";          // { email, token }
    var LEGACY_TOKEN_KEY = "access_token";  // salvo pelo Login

    /* =================== SESSÃO =================== */
    function getSession() {
      try { return JSON.parse(localStorage.getItem(AUTH_KEY) || "null"); }
      catch (e) { return null; }
    }
    function saveSession(email, token) {
      localStorage.setItem(AUTH_KEY, JSON.stringify({ email: email, token: token }));
    }

    // decodifica payload de JWT (base64url)
    function decodeJwtPayload(token){
      try {
        const p = token.split(".")[1].replace(/-/g,"+").replace(/_/g,"/");
        const json = decodeURIComponent(atob(p).split("").map(c=>"%" + ("00"+c.charCodeAt(0).toString(16)).slice(-2)).join(""));
        return JSON.parse(json);
      } catch { return null; }
    }

    // migra o token legado para {email, token}
    function ensureSessionFromLegacy() {
      var s = getSession();
      if (s && s.email && s.token) return;
      var token = localStorage.getItem(LEGACY_TOKEN_KEY);
      if (!token) return;
      var payload = decodeJwtPayload(token);
      var email = payload && (payload.email || payload.sub);
      if (email) saveSession(email, token);
    }

    function buildAuthHeaders(extra) {
      if (!extra) extra = {};
      const t = localStorage.getItem("access_token");
      const h = { "Content-Type": "application/json" };
      if (t) {
        h["Authorization"] = "Bearer " + t;
        const payload = decodeJwtPayload(t);
        const email = (payload && (payload.email || payload.sub)) || "";
        if (email) h["X-User-Email"] = email;
      }
      // merge extras
      for (const k in extra) h[k] = extra[k];
      return h;
    }

    /* =================== HTTP =================== */
    async function httpGet(path) {
      const res = await fetch(API_BASE + "/projects/?mine=1", {
        method: "GET",
        mode: "cors",
        headers: buildAuthHeaders()
      });
      if (!res.ok) {
        let msg = "HTTP " + res.status + " " + res.statusText;
        try { const d = await res.json(); if (d?.detail) msg = d.detail; } catch {}
        throw new Error(msg);
      }
      return res.json();
    }

    /* =================== UI refs =================== */
    var projectsContainer      = document.getElementById("projectsContainer");
    var colaboradoresContainer = document.getElementById("colaboradoresContainer");
    var searchInput            = document.getElementById("searchInput");
    var searchBtn              = document.getElementById("searchBtn");
    var addMemberBtn           = document.getElementById("addMemberBtn");

    
    /* ======================================================= */
    /* ============= NOVAS FUNÇÕES PARA A IA ================= */
    /* ======================================================= */

    /**
     * Renderiza as sugestões da IA dentro do card do projeto.
     */
    function renderSuggestions(projectId, suggestions) {
      // 1. Encontra o card correto
      var card = document.getElementById("project-card-" + projectId);
      if (!card) {
        console.error("Não foi possível encontrar o card do projeto para renderizar sugestões.");
        return;
      }

      // 2. Remove sugestões antigas, se existirem
      var oldContainer = card.querySelector(".suggestions-container");
      if (oldContainer) {
        oldContainer.remove();
      }
      
      // 3. Se não houver novas sugestões, para aqui
      if (!suggestions || suggestions.length === 0) {
        return;
      }

      // 4. Cria o novo container
      var suggestionsContainer = document.createElement("div");
      suggestionsContainer.className = "suggestions-container mt-6 border-t border-gray-200 pt-6"; 

      // 5. Gera o HTML para cada sugestão
      var suggestionsHtml = suggestions.map(function(sugestao) {
        return (
          '<div class="border border-gray-100 bg-gray-50 p-4 rounded-lg">' +
            '<h4 class="text-md font-bold text-gray-900 mb-1">' + sugestao.perfil_sugerido + '</h4>' +
            '<p class="text-sm text-gray-600">' + sugestao.justificativa + '</p>' +
          '</div>'
        );
      }).join("");

      // 6. Define o HTML final do container
      suggestionsContainer.innerHTML = 
        '<h3 class="text-lg font-semibold text-violet-700 mb-4">Sugestões para seu Projeto:</h3>' +
        '<div class="space-y-4">' +
          suggestionsHtml +
        '</div>';

      // 7. Adiciona o container ao card
      card.appendChild(suggestionsContainer);
    }

    /**
     * Envia os dados do projeto para o microserviço de IA.
     */
    async function sendProjectToMicroservice(project, buttonElement) {
      
      // NOTA: 'participantes' está vazio porque esta página não busca 
      // os colaboradores de cada projeto. A IA deve funcionar 
      // com base na descrição e título.
      var payload = {
        "id_projeto": project.id,
        "descricao_projeto": project.description,
        "categoria_projeto": project.categoria || project.title, // Usa 'categoria' se existir, senão 'title'
        "participantes": [] // Array vazio
      };

      console.log("JSON a ser enviado para IA:", JSON.stringify(payload, null, 2));

      // URL do microserviço de IA
      var MICROSERVICE_URL = "https://iaidealizador.azurewebsites.net/api/v1/projetos/sugestoes"; 

      try {
        var res = await fetch(MICROSERVICE_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
            // Nota: Não estamos enviando 'Authorization' para este serviço externo
          },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          var errorText = await res.text();
          throw new Error("HTTP " + res.status + " - " + errorText);
        }

        var responseData = await res.json();
        console.log("Sucesso! Resposta do microserviço:", responseData);

        // Renderiza as sugestões recebidas
        if (responseData.sugestoes && responseData.sugestoes.length > 0) {
          renderSuggestions(project.id, responseData.sugestoes);
        } else {
          // Limpa sugestões antigas se a resposta vier vazia
          renderSuggestions(project.id, []); 
        }

      } catch (e) {
        console.error("Erro ao enviar para o microserviço de IA:", e);
        alert("Erro ao gerar sugestões para '" + project.title + "'. Verifique o console.");
      } finally {
        // Restaura o botão
        if (buttonElement) {
          buttonElement.textContent = "Gerar Sugestões";
          buttonElement.disabled = false;
        }
      }
    }

    /* ======================================================= */
    /* ============= FUNÇÕES EXISTENTES MODIFICADAS ============ */
    /* ======================================================= */


    /* ============ meus projetos (usa X-User-Email) ============ */
    async function listMyProjects() {
      try {
        var s = getSession();
        if (!s || !s.email || !s.token) {
          projectsContainer.innerHTML =
            '<div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-8">' +
            '<p class="text-gray-500 text-center">Faça login para ver seus projetos.</p>' +
            "</div>";
          return;
        }
        var projects = await httpGet("/projects?mine=1");
        renderProjects(projects); // <--- FUNÇÃO MODIFICADA ESTÁ AQUI
      } catch (e) {
        console.error(e);
        projectsContainer.innerHTML =
          '<div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-8">' +
          '<p class="text-gray-500 text-center">Erro ao carregar projetos: ' + e.message + "</p>" +
          "</div>";
      }
    }

    /**
     * FUNÇÃO MODIFICADA
     * Adiciona o botão "Gerar Sugestões" e seu listener.
     */
    function renderProjects(projects) {
      projectsContainer.innerHTML = "";
      if (!projects || projects.length === 0) {
        projectsContainer.innerHTML =
          '<div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-8">' +
          '<p class="text-gray-500 text-center">Nenhum projeto. ' +
          '<a href="../Criar_projeto/criar_projeto.html" class="text-violet-700 hover:underline">Criar primeiro projeto</a></p>' +
          "</div>";
        return;
      }

      // Loop pelos projetos
      for (var i = 0; i < projects.length; i++) {
        var p = projects[i]; // 'p' é o objeto do projeto atual
        var card = document.createElement("div");
        card.className = "bg-white rounded-2xl shadow-sm border border-gray-200 p-8";
        
        // *** MUDANÇA: Adiciona um ID único ao card ***
        card.id = "project-card-" + p.id;
        
        // *** MUDANÇA: Adiciona o novo botão ao HTML ***
        var html = ""
          + '<div class="flex items-start justify-between mb-4">'
          +   '<div class="flex-1">'
          +     '<h3 class="text-xl font-bold text-gray-900 mb-2">' + (p.title || "Sem título") + "</h3>"
          +     '<p class="text-gray-600 text-sm">' + (p.description || "Sem descrição") + "</p>"
          +   "</div>"
          // Wrapper para os botões
          +   '<div class="flex items-center gap-4 ml-4 flex-shrink-0">'
          +     '<a href="../visualizar_projeto/pagina_projeto.html?id=' + p.id + '" class="text-violet-700 hover:text-violet-900 font-medium text-sm">Ver detalhes →</a>'
          // *** ESTE É O NOVO BOTÃO ***
          +     '<button class="send-microservice-btn bg-blue-600 text-white px-3 py-1.5 rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors">Gerar Sugestões</button>'
          +   '</div>' 
          + "</div>";

        card.innerHTML = html;
        projectsContainer.appendChild(card);

        // *** MUDANÇA: Adiciona o listener para o botão que acabamos de criar ***
        var sendBtn = card.querySelector(".send-microservice-btn");
        if (sendBtn) {
            // Usamos uma IIFE (Immediately Invoked Function Expression)
            // para "capturar" o valor correto de 'p' dentro do loop.
            (function(currentProject) { 
                sendBtn.addEventListener("click", function(e) {
                    e.stopPropagation();
                    var btn = e.target;
                    btn.textContent = "Carregando...";
                    btn.disabled = true;
                    // 'currentProject' é o 'p' correto para este card
                    sendProjectToMicroservice(currentProject, btn); 
                });
            })(p); // Passa o 'p' atual para dentro da função
        }
      }
    }

    /* ============ busca mock (mantém placeholder) ============ */
    async function listColaboradores() {
      colaboradoresContainer.classList.remove("hidden");
      colaboradoresContainer.innerHTML =
        '<div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-8">' +
        '<p class="text-gray-500 text-center">Mock: aqui entram os colaboradores de outro micro.</p>' +
        "</div>";
    }
    function doSearch() {
      var q = (searchInput.value || "").trim();
      if (!q) { colaboradoresContainer.classList.add("hidden"); listMyProjects(); return; }
      listColaboradores();
    }

    /* =================== BOOT =================== */
    document.addEventListener("DOMContentLoaded", function () {
      ensureSessionFromLegacy();
      listMyProjects();

      searchBtn.addEventListener("click", doSearch);
      searchInput.addEventListener("keyup", function (e) { if (e.key === "Enter") doSearch(); });
      addMemberBtn.addEventListener("click", function () {
        listColaboradores();
        colaboradoresContainer.scrollIntoView({ behavior: "smooth", block: "start" });
      });
    });
  </script>
  </body>
</html>