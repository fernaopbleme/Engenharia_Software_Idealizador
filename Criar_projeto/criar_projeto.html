<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>TeamBuilder ‚Äî Criar Projeto (MVP)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--bg:#fafafa;--card:#fff;--text:#111;--muted:#666;--border:#e6e6e6;--primary:#4f46e5;--primary-contrast:#fff;--danger:#ef4444;--pill:#f4f4f5;--pill-border:#e4e4e7;--hint-bg:#fff1f2;--hint-text:#9f1239;--success-bg:#ecfdf5;--success-text:#065f46}
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;color:var(--text);background:radial-gradient(1200px 800px at 50% -100px,#ffe6ff66,transparent),var(--bg)}
    .topbar{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:var(--card);border-bottom:1px solid var(--border)}
    .brand{font-weight:700}
    .session{display:flex;gap:8px;align-items:center}
    .session input{padding:8px 10px;border:1px solid var(--border);border-radius:10px}
    .session .btn{padding:8px 12px;border:1px solid var(--border);border-radius:10px;background:var(--card);cursor:pointer}
    .session .btn-primary{background:var(--primary);border-color:var(--primary);color:var(--primary-contrast)}
    .container{max-width:920px;margin:28px auto;padding:0 16px}
    .page-title{text-align:center;margin-bottom:18px}
    .page-title h1{margin:8px 0 4px;font-size:24px}.page-title p{margin:0;color:var(--muted)}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:20px}
    .field{margin-bottom:16px}.label{display:block;font-weight:600;margin-bottom:8px}.hint{font-size:12px;color:var(--muted);margin-top:6px}
    .input,.textarea,.select{width:100%;padding:12px;border:1px solid var(--border);border-radius:12px;background:var(--card);font-size:14px}
    .textarea{min-height:150px;resize:vertical}
    .row{display:grid;gap:10px;grid-template-columns:1fr}
    @media (min-width:760px){.row.two{grid-template-columns:1fr 220px}}
    .skill-actions{display:flex;gap:8px;align-items:center}
    .btn{padding:10px 14px;border:1px solid var(--border);border-radius:12px;background:var(--card);cursor:pointer}
    .btn:hover{background:#f7f7f7}.btn-primary{background:var(--primary);color:var(--primary-contrast);border-color:var(--primary)}
    .btn-danger{border-color:#fecaca;color:var(--danger);background:#fff}
    .skills-list{display:flex;flex-direction:column;gap:8px;margin-top:10px}
    .skill-item{display:flex;gap:10px;align-items:center;justify-content:space-between;border:1px dashed var(--pill-border);background:var(--pill);padding:10px 12px;border-radius:12px}
    .skill-item .meta{display:flex;gap:10px;align-items:center}.chip{padding:4px 8px;border-radius:999px;background:#eef2ff;color:#3730a3;font-size:12px;border:1px solid #e0e7ff}
    .empty{display:grid;place-items:center;text-align:center;border-radius:12px;border:1px dashed var(--border);background:#fff7ed;color:#7c2d12;padding:18px;font-size:14px}
    .footer-actions{display:flex;gap:10px;justify-content:center;margin-top:18px}
    .alert{margin-top:12px;padding:10px 12px;border-radius:12px;font-size:14px;border:1px solid transparent;display:none}
    .alert.error{display:block;background:#fff1f2;color:var(--hint-text);border-color:#ffe4e6}
    .alert.success{display:block;background:var(--success-bg);color:var(--success-text);border-color:#a7f3d0}
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand">TeamBuilder</div>
    <div class="session" id="sessionBox">
      <input id="emailInput" type="email" placeholder="e-mail" />
      <input id="passInput" type="password" placeholder="senha" />
      <button id="loginBtn" class="btn btn-primary">Entrar</button>
      <button id="logoutBtn" class="btn" style="display:none">Sair</button>
      <span id="whoami" style="color:#555"></span>
    </div>
  </header>

  <main class="container">
    <div class="page-title">
      <div style="width:56px;height:56px;margin:0 auto;background:linear-gradient(135deg,#a78bfa,#f472b6);border-radius:999px;display:grid;place-items:center;color:#fff;">üí°</div>
      <h1>Criar Novo Projeto</h1>
      <p>Compartilhe sua ideia e encontre os membros perfeitos para a equipe</p>
    </div>

    <section class="card">
      <form id="projectForm" novalidate>
        <div class="field">
          <label class="label" for="title">T√≠tulo do Projeto</label>
          <input class="input" id="title" name="title" type="text" placeholder="Digite o nome do seu projeto..." required />
        </div>

        <div class="field">
          <label class="label" for="description">Descri√ß√£o do Projeto</label>
          <textarea class="textarea" id="description" name="description" placeholder="Descreva sua ideia, objetivos e o que espera alcan√ßar..." required></textarea>
          <div class="hint">Seja espec√≠fico sobre o que est√° construindo e por que √© importante</div>
        </div>

        <div class="field">
          <label class="label" for="category">Categoria</label>
          <input class="input" id="category" name="category" type="text" placeholder="ex.: engenharia e m√∫sica" required />
          <div class="hint">Tema/√°rea do projeto (uma express√£o curta)</div>
        </div>

        <div class="field">
          <label class="label">Habilidades Necess√°rias</label>
          <div class="row two">
            <input class="input" id="skillName" type="text" placeholder="ex: React, Python, Design UI..." />
            <select class="select" id="skillLevel">
              <option value="BEGINNER">Iniciante</option>
              <option value="INTERMEDIATE" selected>Intermedi√°rio</option>
              <option value="ADVANCED">Avan√ßado</option>
            </select>
          </div>
          <div class="skill-actions" style="margin-top:8px">
            <button type="button" id="addSkillBtn" class="btn btn-primary">+ Adicionar</button>
          </div>

          <div id="skillsList" class="skills-list"></div>
          <div id="skillsEmpty" class="empty">Nenhuma habilidade adicionada ainda. Comece adicionando as habilidades que seu projeto precisa!</div>
        </div>

        <div id="formAlert" class="alert"></div>

        <div class="footer-actions">
          <button type="submit" class="btn btn-primary" id="createBtn">Criar Projeto</button>
          <button type="button" class="btn" id="cancelBtn">Cancelar</button>
        </div>
      </form>
    </section>
  </main>

  <script>
    // ====== CONFIG ======
    const API_BASE  = "https://bdprojetos.azurewebsites.net";         // micro de projetos
    const AUTH_BASE = "https://SEU-AUTH.azurewebsites.net";            // <<< TROQUE para o micro de login

    // ====== AUTH STORE (persist√™ncia de sess√£o) ======
    const AUTH_KEY = "auth.user"; // { email, token }
    const authStore = {
      get(){ try{ return JSON.parse(localStorage.getItem(AUTH_KEY)||"null"); }catch{return null} },
      set(v){ localStorage.setItem(AUTH_KEY, JSON.stringify(v)); },
      clear(){ localStorage.removeItem(AUTH_KEY); }
    };
    const getEmail = () => authStore.get()?.email || "";
    const getToken = () => authStore.get()?.token || "";

    // Normaliza poss√≠veis nomes de campos vindos do /login
    function pickTokenAndEmail(loginResponse, fallbackEmail) {
      const token = loginResponse.access_token || loginResponse.token || loginResponse.jwt || "";
      const email = loginResponse.email || loginResponse.user?.email || fallbackEmail || "";
      return { token, email };
    }

    // ====== LOGIN / LOGOUT ======
    async function loginWithPassword(email, password) {
      const resp = await fetch(`${AUTH_BASE}/login`, {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({ email, password })
      });
      if (!resp.ok) {
        const err = await resp.json().catch(()=>({}));
        throw new Error(err.detail || `${resp.status} ${resp.statusText}`);
      }
      const data = await resp.json();
      const { token, email: resolvedEmail } = pickTokenAndEmail(data, email);
      if (!token) throw new Error("Auth n√£o retornou token");

      // Opcional: confirmar no /me (se existir) para pegar email oficial do token
      try {
        const meResp = await fetch(`${AUTH_BASE}/me`, { headers: { Authorization: `Bearer ${token}` } });
        if (meResp.ok) {
          const me = await meResp.json();
          if (me?.email) authStore.set({ token, email: me.email });
          else authStore.set({ token, email: resolvedEmail });
        } else {
          authStore.set({ token, email: resolvedEmail });
        }
      } catch {
        authStore.set({ token, email: resolvedEmail });
      }
      paintSession();
    }

    function logout(){ authStore.clear(); paintSession(); }

    // ====== UI Sess√£o ======
    const emailInput = document.getElementById("emailInput");
    const passInput  = document.getElementById("passInput");
    const loginBtn   = document.getElementById("loginBtn");
    const logoutBtn  = document.getElementById("logoutBtn");
    const whoami     = document.getElementById("whoami");

    loginBtn.onclick = async ()=> {
      loginBtn.disabled = true;
      try{
        await loginWithPassword(emailInput.value.trim(), passInput.value);
      }catch(e){ alert(e.message||"Erro ao entrar"); }
      finally{ loginBtn.disabled = false; }
    };
    logoutBtn.onclick = ()=> logout();

    function paintSession(){
      const email = getEmail();
      const logged = !!getToken();
      emailInput.style.display = logged ? "none" : "";
      passInput.style.display  = logged ? "none" : "";
      loginBtn.style.display   = logged ? "none" : "";
      logoutBtn.style.display  = logged ? "" : "none";
      whoami.textContent = logged ? `Ol√°, ${email}` : "";
    }
    paintSession();

    // ====== N√çVEIS ======
    const LEVEL_UI_TO_API = { BEGINNER:"beginner", INTERMEDIATE:"intermediate", ADVANCED:"advanced" };

    // ====== ESTADO LOCAL ======
    const skills = [];
    const knownTags = [];

    // ====== UI refs ======
    const skillsList = document.getElementById('skillsList');
    const skillsEmpty = document.getElementById('skillsEmpty');
    const addSkillBtn = document.getElementById('addSkillBtn');
    const skillName = document.getElementById('skillName');
    const skillLevel = document.getElementById('skillLevel');
    const form = document.getElementById('projectForm');
    const alertBox = document.getElementById('formAlert');
    const cancelBtn = document.getElementById('cancelBtn');

    function showAlert(type,msg){ alertBox.className='alert '+type; alertBox.textContent=msg; }
    function clearAlert(){ alertBox.className='alert'; alertBox.textContent=''; }

    function renderSkills(){
      skillsList.innerHTML='';
      if(!skills.length){ skillsEmpty.style.display='grid'; return; }
      skillsEmpty.style.display='none';
      skills.forEach((s,idx)=>{
        const row=document.createElement('div'); row.className='skill-item';
        const meta=document.createElement('div'); meta.className='meta';
        const name=document.createElement('strong'); name.textContent=s.name;
        const level=document.createElement('span'); level.className='chip';
        level.textContent = s.level==='BEGINNER'?'Iniciante':(s.level==='ADVANCED'?'Avan√ßado':'Intermedi√°rio');
        meta.appendChild(name); meta.appendChild(level);
        const remove=document.createElement('button'); remove.type='button'; remove.className='btn btn-danger'; remove.textContent='Remover';
        remove.onclick=()=>{ skills.splice(idx,1); renderSkills(); };
        row.appendChild(meta); row.appendChild(remove); skillsList.appendChild(row);
      });
    }

    // ====== HTTP helper (inclui Bearer + X-User-Email) ======
    async function http(path, init={}){
      const headers = { "Content-Type":"application/json", ...(init.headers||{}) };
      const email = getEmail();
      const token = getToken();
      if(email) headers["X-User-Email"] = email;
      if(token) headers["Authorization"] = `Bearer ${token}`;

      const res = await fetch(API_BASE+path, { ...init, headers });
      if(!res.ok){
        let msg = res.status+" "+res.statusText;
        try{ const d = await res.json(); if(d?.detail) msg=d.detail; }catch{}
        throw new Error(msg);
      }
      const text = await res.text();
      return text ? JSON.parse(text) : null;
    }

    const api = {
      listTags: (q)=> http('/tags/'+(q?('?q='+encodeURIComponent(q)):'') ),
      createTag: (body)=> http('/tags/', { method:'POST', body:JSON.stringify(body) }),
      createProj: (body)=> http('/projects/', { method:'POST', body:JSON.stringify(body) })
    };

    // ====== Regras de tags ======
    async function ensureTagIdByName(name){
      const nm=(name||'').trim(); if(!nm) throw new Error('Nome da habilidade vazio');
      const lower = nm.toLowerCase();
      let t = knownTags.find(x=>x.name.toLowerCase()===lower);
      if(!t){
        const found = await api.listTags(nm);
        t = found.find(x=>x.name.toLowerCase()===lower);
      }
      if(!t){
        t = await api.createTag({ name:nm });
        knownTags.push(t);
      }
      return t.id;
    }

    // ====== Criar projeto ======
    async function createProjectFromUI({ title, description, category, uiSkills }) {
      const links = [];
      for (const s of uiSkills) {
        const tag_id = await ensureTagIdByName(s.name);
        const skill_level = LEVEL_UI_TO_API[s.level] || 'intermediate';
        const i = links.findIndex(l => l.tag_id === tag_id);
        if (i >= 0) links[i].skill_level = skill_level; else links.push({ tag_id, skill_level });
      }
      const payload = { title, description, category, tags: links };
      return api.createProj(payload);
    }

    // ====== Eventos ======
    addSkillBtn.onclick = ()=>{
      clearAlert();
      const name=(skillName.value||'').trim();
      if(!name) return showAlert('error','Informe o nome da habilidade antes de adicionar.');
      if(skills.some(s=>s.name.toLowerCase()===name.toLowerCase()))
        return showAlert('error','Essa habilidade j√° foi adicionada.');
      skills.push({ name, level: skillLevel.value });
      skillName.value=''; renderSkills();
    };

    cancelBtn.onclick = ()=>{ if(document.referrer) history.back(); else window.location.href='/'; };

    form.addEventListener('submit', async (e)=>{
      e.preventDefault(); clearAlert();
      if(!getEmail() || !getToken()) return showAlert('error','Voc√™ precisa entrar antes de criar o projeto.');

      const title=document.getElementById('title').value.trim();
      const description=document.getElementById('description').value.trim();
      const category=document.getElementById('category').value.trim();
      if(!title) return showAlert('error','O t√≠tulo do projeto √© obrigat√≥rio.');
      if(!description) return showAlert('error','A descri√ß√£o do projeto √© obrigat√≥ria.');
      if(!category) return showAlert('error','A categoria do projeto √© obrigat√≥ria.');

      try{
        await createProjectFromUI({ title, description, category, uiSkills: skills });
        showAlert('success','Projeto criado com sucesso!');
        document.getElementById('title').value='';
        document.getElementById('description').value='';
        document.getElementById('category').value='';
        skills.length=0; renderSkills();
      }catch(err){
        showAlert('error','Falha ao criar o projeto. '+(err.message||''));
      }
    });

    renderSkills();
  </script>
</body>
</html>
