<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>TeamBuilder ‚Äî Criar Projeto (MVP)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{--bg:#f9fafb;--card:#fff;--text:#111;--muted:#666;--border:#e6e6e6;--primary:#4f46e5;--primary-contrast:#fff;--danger:#ef4444;--pill:#f4f4f5;--pill-border:#e4e4e7;--success-bg:#ecfdf5;--success-text:#065f46}
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;color:var(--text);background:var(--bg)}
    .topbar{display:flex;align-items:center;justify-content:space-between;padding:14px 20px;background:linear-gradient(90deg,#6366f1,#8b5cf6,#7c3aed);color:#fff;box-shadow:0 10px 25px -15px rgba(79,70,229,.8);border-bottom:1px solid rgba(255,255,255,.15)}
    .brand{font-weight:700;color:#fff}
    .topbar-actions{display:flex;align-items:center;gap:12px}
    .topbar-btn{padding:12px 16px;border-radius:12px;border:1px solid transparent;background:rgba(255,255,255,.12);color:#fff;font-size:14px;font-weight:500;cursor:pointer;transition:all .2s ease}
    .topbar-btn:hover{background:rgba(255,255,255,.22)}
    #whoami{color:#fff;font-size:14px;opacity:.9}
    .container{max-width:920px;margin:28px auto;padding:0 16px}
    .page-title{text-align:center;margin-bottom:18px}
    .page-title h1{margin:8px 0 4px;font-size:24px}.page-title p{margin:0;color:var(--muted)}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:20px}
    .field{margin-bottom:16px}.label{display:block;font-weight:600;margin-bottom:8px}.hint{font-size:12px;color:var(--muted);margin-top:6px}
    .input,.textarea,.select{width:100%;padding:12px;border:1px solid var(--border);border-radius:12px;background:var(--card);font-size:14px}
    .textarea{min-height:150px;resize:vertical}
    .row{display:grid;gap:10px;grid-template-columns:1fr}
    @media (min-width:760px){.row.two{grid-template-columns:1fr 220px}}
    .skill-actions{display:flex;gap:8px;align-items:center}
    .btn{padding:10px 14px;border:1px solid var(--border);border-radius:12px;background:var(--card);cursor:pointer}
    .btn:hover{background:#f7f7f7}.btn-primary{background:var(--primary);color:var(--primary-contrast);border-color:var(--primary)}
    .btn-danger{border-color:#fecaca;color:var(--danger);background:#fff}
    .skills-list{display:flex;flex-direction:column;gap:8px;margin-top:10px}
    .skill-item{display:flex;gap:10px;align-items:center;justify-content:space-between;border:1px dashed var(--pill-border);background:var(--pill);padding:10px 12px;border-radius:12px}
    .skill-item .meta{display:flex;gap:10px;align-items:center}.chip{padding:4px 8px;border-radius:999px;background:#eef2ff;color:#3730a3;font-size:12px;border:1px solid #e0e7ff}
    .empty{display:grid;place-items:center;text-align:center;border-radius:12px;border:1px dashed var(--border);background:#fff7ed;color:#7c2d12;padding:18px;font-size:14px}
    .footer-actions{display:flex;gap:10px;justify-content:center;margin-top:18px}
    .alert{margin-top:12px;padding:10px 12px;border-radius:12px;font-size:14px;border:1px solid transparent;display:none}
    .alert.error{display:block;background:#fff1f2;color:#9f1239;border-color:#ffe4e6}
    .alert.success{display:block;background:var(--success-bg);color:var(--success-text);border-color:#a7f3d0}
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand">TeamBuilder</div>
    <div class="topbar-actions">
      <button type="button" id="backBtn" class="topbar-btn">‚Üê Voltar</button>
      <div id="whoami"></div>
    </div>
  </header>

  <main class="container">
    <div class="page-title">
      <div style="width:56px;height:56px;margin:0 auto;background:linear-gradient(135deg,#a78bfa,#f472b6);border-radius:999px;display:grid;place-items:center;color:#fff;">üí°</div>
      <h1>Criar Novo Projeto</h1>
      <p>Compartilhe sua ideia e encontre os membros perfeitos para a equipe</p>
    </div>

    <section class="card">
      <form id="projectForm" novalidate>
        <div class="field">
          <label class="label" for="title">T√≠tulo do Projeto</label>
          <input class="input" id="title" name="title" type="text" placeholder="Digite o nome do seu projeto..." required />
        </div>

        <div class="field">
          <label class="label" for="description">Descri√ß√£o do Projeto</label>
          <textarea class="textarea" id="description" name="description" placeholder="Descreva sua ideia, objetivos e o que espera alcan√ßar..." required></textarea>
          <div class="hint">Seja espec√≠fico sobre o que est√° construindo e por que √© importante</div>
        </div>

        <div class="field">
          <label class="label" for="category">Categoria</label>
          <input class="input" id="category" name="category" type="text" placeholder="ex.: engenharia e m√∫sica" required />
          <div class="hint">Tema/√°rea do projeto (uma express√£o curta)</div>
        </div>

        <div class="field">
          <label class="label">Habilidades Necess√°rias</label>
          <div class="row two">
            <input class="input" id="skillName" type="text" placeholder="ex: React, Python, Design UI..." />
            <select class="select" id="skillLevel">
              <option value="BEGINNER">Iniciante</option>
              <option value="INTERMEDIATE" selected>Intermedi√°rio</option>
              <option value="ADVANCED">Avan√ßado</option>
            </select>
          </div>
          <div class="skill-actions" style="margin-top:8px">
            <button type="button" id="addSkillBtn" class="btn btn-primary">+ Adicionar</button>
          </div>

          <div id="skillsList" class="skills-list"></div>
          <div id="skillsEmpty" class="empty">Nenhuma habilidade adicionada ainda. Comece adicionando as habilidades que seu projeto precisa!</div>
        </div>

        <div id="formAlert" class="alert"></div>

        <div class="footer-actions">
          <button type="submit" class="btn btn-primary" id="createBtn">Criar Projeto</button>
          <button type="button" class="btn" id="cancelBtn">Cancelar</button>
        </div>
      </form>
    </section>
  </main>

  <script>
    // ========= CONFIG =========
    var API_BASE = "https://bdprojetos.azurewebsites.net";  // ajuste se necess√°rio
    var LOGIN_PAGE = "../login/login.html";                        // para redirecionar se n√£o logado

    // ========= JWT / SESS√ÉO =========
    function decodeJwtPayload(token){
      try{
        var parts = token.split(".");
        if (parts.length < 2) return null;
        var b64 = parts[1].replace(/-/g, "+").replace(/_/g, "/");
        while (b64.length % 4 !== 0) b64 += "=";
        var json = decodeURIComponent(atob(b64).split("").map(function(c){
          return "%" + ("00" + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(""));
        return JSON.parse(json);
      }catch(e){ return null; }
    }

    function getToken(){
      // token salvo pela p√°gina de login
      return localStorage.getItem("access_token") || null;
    }

    function getEmailFromToken(token){
      var p = decodeJwtPayload(token);
      if (!p) return null;
      return p.email || p.sub || null;
    }

    function buildAuthHeaders(extra){
      if (!extra) extra = {};
      var t = getToken();
      if (!t) return extra; // ser√° barrado no guard
      var email = getEmailFromToken(t) || "";
      var h = { "Content-Type": "application/json" };
      h["Authorization"] = "Bearer " + t;
      if (email) h["X-User-Email"] = email;
      // mescla extras
      for (var k in extra) { h[k] = extra[k]; }
      return h;
    }

    function requireLogged(){
      var t = getToken();
      if (!t){
        window.location.href = LOGIN_PAGE;
        return false;
      }
      var who = document.getElementById("whoami");
      var email = getEmailFromToken(t);
      if (who && email) who.textContent = "Ol√°, " + email;
      return true;
    }

    // ========= HTTP HELPERS =========
    async function http(path, init){
      var res = await fetch(API_BASE + path, init);
      if (!res.ok){
        var msg = "HTTP " + res.status + " " + res.statusText;
        try { var d = await res.json(); if (d && d.detail) msg = d.detail; } catch(e){}
        throw new Error(msg);
      }
      var txt = await res.text();
      return txt ? JSON.parse(txt) : null;
    }

    async function httpAuthed(path, init){
      init = init || {};
      init.headers = buildAuthHeaders(init.headers || {});
      return http(path, init);
    }

    // ========= TAGS (garantir id) =========
    async function listTags(q){
      var url = "/tags/";
      if (q && q.trim()){
        url = "/tags/?q=" + encodeURIComponent(q.trim());
      }
      return httpAuthed(url, { method: "GET" });
    }

    async function createTag(body){
      return httpAuthed("/tags/", {
        method: "POST",
        body: JSON.stringify(body)
      });
    }

    async function ensureTagIdByName(name){
      var nm = (name || "").trim();
      if (!nm) throw new Error("Nome da habilidade vazio.");
      var all = await listTags(nm);
      var lower = nm.toLowerCase();
      var hit = null;
      if (Array.isArray(all)){
        for (var i=0;i<all.length;i++){
          if ((all[i].name || "").toLowerCase() === lower){ hit = all[i]; break; }
        }
      }
      if (!hit) hit = await createTag({ name: nm });
      return hit.id;
    }

    // ========= PROJETOS =========
    var LEVEL_UI_TO_API = { BEGINNER:"beginner", INTERMEDIATE:"intermediate", ADVANCED:"advanced" };

    async function createProject(payload){
      return httpAuthed("/projects/", {
        method: "POST",
        body: JSON.stringify(payload)
      });
    }

    async function createProjectFromUI(title, description, category, uiSkills){
      var links = []; // { tag_id, skill_level }
      for (var i=0;i<uiSkills.length;i++){
        var s = uiSkills[i];
        var tagId = await ensureTagIdByName(s.name);
        var lvl = LEVEL_UI_TO_API[s.level] || "intermediate";
        // evita duplicar tag
        var idx = -1;
        for (var j=0;j<links.length;j++){ if (links[j].tag_id === tagId){ idx = j; break; } }
        if (idx >= 0) links[idx].skill_level = lvl;
        else links.push({ tag_id: tagId, skill_level: lvl });
      }
      var body = { title: title, description: description, category: category, tags: links };
      return createProject(body);
    }

    // ========= UI / ESTADO =========
    var skills = []; // { name, level }

    var $ = function(id){ return document.getElementById(id); };
    var skillsList  = $("skillsList");
    var skillsEmpty = $("skillsEmpty");
    var addSkillBtn = $("addSkillBtn");
    var skillName   = $("skillName");
    var skillLevel  = $("skillLevel");
    var form        = $("projectForm");
    var alertBox    = $("formAlert");
    var cancelBtn   = $("cancelBtn");
    var backBtn     = $("backBtn");

    function showAlert(type, msg){
      alertBox.className = "alert " + type;
      alertBox.textContent = msg;
    }
    function clearAlert(){
      alertBox.className = "alert";
      alertBox.textContent = "";
    }

    function renderSkills(){
      skillsList.innerHTML = "";
      if (skills.length === 0){
        skillsEmpty.style.display = "grid";
        return;
      }
      skillsEmpty.style.display = "none";
      for (var i=0;i<skills.length;i++){
        (function(idx){
          var s = skills[idx];
          var row = document.createElement("div");
          row.className = "skill-item";

          var meta = document.createElement("div");
          meta.className = "meta";

          var nameEl = document.createElement("strong");
          nameEl.textContent = s.name;

          var levelEl = document.createElement("span");
          levelEl.className = "chip";
          levelEl.textContent = (s.level === "BEGINNER") ? "Iniciante" :
                                 (s.level === "ADVANCED") ? "Avan√ßado" : "Intermedi√°rio";

          meta.appendChild(nameEl);
          meta.appendChild(levelEl);

          var rem = document.createElement("button");
          rem.type = "button";
          rem.className = "btn btn-danger";
          rem.textContent = "Remover";
          rem.onclick = function(){
            skills.splice(idx, 1);
            renderSkills();
          };

          row.appendChild(meta);
          row.appendChild(rem);
          skillsList.appendChild(row);
        })(i);
      }
    }

    // ========= Eventos =========
    document.addEventListener("DOMContentLoaded", function(){
      if (!requireLogged()) return;

      var email = getEmailFromToken(getToken());
      var who = document.getElementById("whoami");
      if (who && email) who.textContent = "Ol√°, " + email;

      addSkillBtn.addEventListener("click", function(){
        clearAlert();
        var nm = (skillName.value || "").trim();
        if (!nm){ showAlert("error", "Informe o nome da habilidade antes de adicionar."); return; }
        var exists = false;
        for (var i=0;i<skills.length;i++){
          if (skills[i].name.toLowerCase() === nm.toLowerCase()){ exists = true; break; }
        }
        if (exists){ showAlert("error", "Essa habilidade j√° foi adicionada."); return; }
        var lvl = skillLevel.value || "INTERMEDIATE";
        skills.push({ name: nm, level: lvl });
        skillName.value = "";
        renderSkills();
      });

      cancelBtn.addEventListener("click", function(){
        if (document.referrer) history.back();
        else window.location.href = "../home/home.html";
      });

      if (backBtn){
        backBtn.addEventListener("click", function(){
          if (history.length > 1) history.back();
          else window.location.href = "../home/home.html";
        });
      }

      form.addEventListener("submit", function(e){
        e.preventDefault();
        clearAlert();

        var title = $("title").value.trim();
        var description = $("description").value.trim();
        var category = $("category").value.trim();

        if (!title){ showAlert("error", "O t√≠tulo do projeto √© obrigat√≥rio."); return; }
        if (!description){ showAlert("error", "A descri√ß√£o do projeto √© obrigat√≥ria."); return; }
        if (!category){ showAlert("error", "A categoria do projeto √© obrigat√≥ria."); return; }

        createProjectFromUI(title, description, category, skills)
          .then(function(){
            showAlert("success", "Projeto criado com sucesso!");
            $("title").value = "";
            $("description").value = "";
            $("category").value = "";
            skills = [];
            renderSkills();
          })
          .catch(function(err){
            showAlert("error", "Falha ao criar o projeto. " + (err && err.message ? err.message : ""));
          });
      });

      renderSkills();
    });
  </script>
</body>
</html>
